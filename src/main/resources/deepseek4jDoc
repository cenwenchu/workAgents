ç»“åˆä½ æä¾›çš„ `DeepSeekClient` ä»£ç ï¼Œæˆ‘æ¥å±•ç¤ºå®Œæ•´çš„è¯·æ±‚å’Œè¿”å›å¤„ç†èŒƒä¾‹ã€‚è¿™ä¸ªå®¢æˆ·ç«¯æ”¯æŒåŒæ­¥ã€å¼‚æ­¥å’Œæµå¼ä¸‰ç§è°ƒç”¨æ–¹å¼ã€‚

## ğŸ“¦ å®Œæ•´çš„å®¢æˆ·ç«¯ä½¿ç”¨ç¤ºä¾‹

### 1. **åŸºç¡€åŒæ­¥è°ƒç”¨**

```java
import io.github.pigmesh.ai.deepseek.core.DeepSeekClient;
import io.github.pigmesh.ai.deepseek.core.chat.*;
import io.github.pigmesh.ai.deepseek.core.chat.ChatCompletionResponse;
import io.github.pigmesh.ai.deepseek.core.chat.ChatCompletionRequest;

public class BasicSyncExample {
    public static void main(String[] args) {
        // 1. åˆå§‹åŒ–å®¢æˆ·ç«¯
        DeepSeekClient client = DeepSeekClient.builder()
            .openAiApiKey("sk-your-deepseek-api-key")  // ä½ çš„APIå¯†é’¥
            .baseUrl("https://api.deepseek.com")        // DeepSeek APIåœ°å€
            .model("deepseek-chat")                     // é»˜è®¤æ¨¡å‹
            .connectTimeout(java.time.Duration.ofSeconds(30))
            .readTimeout(java.time.Duration.ofSeconds(60))
            .logRequests(true)                          // å¼€å¯è¯·æ±‚æ—¥å¿—
            .logResponses(true)                         // å¼€å¯å“åº”æ—¥å¿—
            .build();
        
        try {
            // 2. æ„å»ºè¯·æ±‚
            ChatCompletionRequest request = ChatCompletionRequest.builder()
                .addSystemMessage("ä½ æ˜¯ä¸€ä¸ªJavaç¼–ç¨‹ä¸“å®¶")
                .addUserMessage("è§£é‡Šä¸€ä¸‹Javaä¸­çš„Stream APIæœ‰ä»€ä¹ˆä¼˜åŠ¿ï¼Ÿ")
                .maxCompletionTokens(1000)
                .temperature(0.7)
                .build();
            
            // 3. åŒæ­¥è°ƒç”¨
            System.out.println("å‘é€è¯·æ±‚åˆ°DeepSeek...");
            ChatCompletionResponse response = client
                .chatCompletion(new io.github.pigmesh.ai.deepseek.core.OpenAiClientContext(), request)
                .execute();
            
            // 4. å¤„ç†å“åº”
            if (response != null && response.choices() != null && !response.choices().isEmpty()) {
                String answer = response.choices().get(0).message().content();
                System.out.println("\n=== DeepSeek å›ç­” ===");
                System.out.println(answer);
                
                // æ‰“å°ä½¿ç”¨ç»Ÿè®¡
                System.out.println("\n=== ä½¿ç”¨ç»Ÿè®¡ ===");
                System.out.println("Prompt tokens: " + response.usage().promptTokens());
                System.out.println("Completion tokens: " + response.usage().completionTokens());
                System.out.println("Total tokens: " + response.usage().totalTokens());
            }
            
        } catch (Exception e) {
            System.err.println("è°ƒç”¨å¤±è´¥: " + e.getMessage());
            e.printStackTrace();
        } finally {
            // 5. å…³é—­å®¢æˆ·ç«¯
            client.shutdown();
        }
    }
}
```

### 2. **å¼‚æ­¥è°ƒç”¨ç¤ºä¾‹**

```java
import io.github.pigmesh.ai.deepseek.core.DeepSeekClient;
import io.github.pigmesh.ai.deepseek.core.chat.*;
import java.util.concurrent.CompletableFuture;

public class AsyncExample {
    public static void main(String[] args) {
        DeepSeekClient client = DeepSeekClient.builder()
            .openAiApiKey("sk-your-key")
            .build();
        
        // æ„å»ºåŒ…å«ä»£ç çš„è¯·æ±‚
        ChatCompletionRequest request = ChatCompletionRequest.builder()
            .addSystemMessage("""
                ä½ æ˜¯ä¸€ä¸ªä»£ç å®¡æŸ¥ä¸“å®¶ï¼Œè¯·æŒ‰ä»¥ä¸‹æ ¼å¼å›ç­”ï¼š
                1. å®‰å…¨é—®é¢˜
                2. æ€§èƒ½é—®é¢˜
                3. æ”¹è¿›å»ºè®®
                """)
            .addUserMessage("""
                å®¡æŸ¥è¿™æ®µä»£ç ï¼š
                ```java
                public void processData(List<String> data) {
                    for (String item : data) {
                        System.out.println(item.toUpperCase());
                    }
                }
                ```
                """)
            .maxCompletionTokens(1500)
            .temperature(0.3)
            .build();
        
        // å¼‚æ­¥è°ƒç”¨
        CompletableFuture<ChatCompletionResponse> future = client
            .chatCompletion(new io.github.pigmesh.ai.deepseek.core.OpenAiClientContext(), request)
            .onResponse(response -> {
                System.out.println("å¼‚æ­¥è°ƒç”¨å®Œæˆï¼");
                if (response.choices() != null) {
                    System.out.println("å›ç­”: " + response.choices().get(0).message().content());
                }
                return response;
            })
            .onError(error -> {
                System.err.println("å¼‚æ­¥è°ƒç”¨å¤±è´¥: " + error.getMessage());
                return null;
            })
            .executeAsync();
        
        // ç­‰å¾…å¼‚æ­¥è°ƒç”¨å®Œæˆï¼ˆåœ¨å®é™…åº”ç”¨ä¸­å¯èƒ½ä¸éœ€è¦ï¼‰
        try {
            future.get(); // é˜»å¡ç­‰å¾…
        } catch (Exception e) {
            e.printStackTrace();
        }
        
        client.shutdown();
    }
}
```

### 3. **æµå¼å“åº”å¤„ç†**

```java
import io.github.pigmesh.ai.deepseek.core.DeepSeekClient;
import io.github.pigmesh.ai.deepseek.core.chat.*;
import io.github.pigmesh.ai.deepseek.core.shared.StreamOptions;
import reactor.core.publisher.Flux;

public class StreamingExample {
    public static void main(String[] args) throws InterruptedException {
        DeepSeekClient client = DeepSeekClient.builder()
            .openAiApiKey("sk-your-key")
            .logStreamingResponses(true)  // å¼€å¯æµå¼å“åº”æ—¥å¿—
            .build();
        
        // æ„å»ºæµå¼è¯·æ±‚
        ChatCompletionRequest request = ChatCompletionRequest.builder()
            .model("deepseek-chat")
            .addUserMessage("ç”¨Javaå†™ä¸€ä¸ªå¿«é€Ÿæ’åºç®—æ³•çš„å®ç°ï¼Œå¹¶é€æ­¥è§£é‡Š")
            .stream(true)  // å¯ç”¨æµå¼
            .streamOptions(StreamOptions.builder().includeUsage(true).build())
            .maxCompletionTokens(2000)
            .temperature(0.5)
            .build();
        
        System.out.println("å¼€å§‹æµå¼å“åº”...\n");
        
        // æ–¹æ³•1: ä½¿ç”¨ Fluxï¼ˆå“åº”å¼ç¼–ç¨‹ï¼‰
        Flux<ChatCompletionResponse> flux = client.chatFluxCompletion(request);
        
        flux.subscribe(
            chunk -> {
                // å¤„ç†æ¯ä¸ªæµå¼å—
                if (chunk.choices() != null && !chunk.choices().isEmpty()) {
                    String delta = chunk.choices().get(0).delta().content();
                    if (delta != null) {
                        System.out.print(delta);  // é€ä¸ªå­—ç¬¦è¾“å‡º
                    }
                }
            },
            error -> System.err.println("\næµå¼é”™è¯¯: " + error.getMessage()),
            () -> System.out.println("\n\næµå¼å“åº”å®Œæˆï¼")
        );
        
        // æ–¹æ³•2: ä½¿ç”¨å›è°ƒæ–¹å¼
        client.chatCompletion(new io.github.pigmesh.ai.deepseek.core.OpenAiClientContext(), request)
            .onPartialResponse(chunk -> {
                // å®æ—¶å¤„ç†éƒ¨åˆ†å“åº”
                if (chunk.choices() != null && !chunk.choices().isEmpty()) {
                    String content = chunk.choices().get(0).delta().content();
                    if (content != null) {
                        System.out.print(content);
                    }
                }
            })
            .onComplete(() -> {
                System.out.println("\n\næµå¼è°ƒç”¨å®Œæˆ");
            })
            .onError(error -> {
                System.err.println("æµå¼è°ƒç”¨é”™è¯¯: " + error.getMessage());
            })
            .execute();
        
        // ç­‰å¾…æµå¼å“åº”å®Œæˆ
        Thread.sleep(10000);
        client.shutdown();
    }
}
```

## ğŸ–¼ï¸ å¤šæ¨¡æ€æ–‡ä»¶å¤„ç†ç¤ºä¾‹

### 4. **å›¾ç‰‡åˆ†æå®Œæ•´æµç¨‹**

```java
import io.github.pigmesh.ai.deepseek.core.DeepSeekClient;
import io.github.pigmesh.ai.deepseek.core.chat.*;
import io.github.pigmesh.ai.deepseek.core.chat.ImageDetail;
import java.io.File;
import java.nio.file.Files;
import java.util.Base64;

public class ImageAnalysisExample {
    
    public static void main(String[] args) {
        try {
            DeepSeekClient client = DeepSeekClient.builder()
                .openAiApiKey("sk-your-key")
                .build();
            
            // 1. æœ¬åœ°å›¾ç‰‡è½¬base64
            File imageFile = new File("architecture.png");
            byte[] imageBytes = Files.readAllBytes(imageFile.toPath());
            String base64Image = Base64.getEncoder().encodeToString(imageBytes);
            String dataUrl = "data:image/png;base64," + base64Image;
            
            // 2. æ„å»ºå¤šæ¨¡æ€è¯·æ±‚
            ChatCompletionRequest request = ChatCompletionRequest.builder()
                .model("deepseek-chat")  // æˆ–ä½¿ç”¨ä¸“é—¨çš„è§†è§‰æ¨¡å‹
                .addSystemMessage("""
                    ä½ æ˜¯è½¯ä»¶æ¶æ„åˆ†æä¸“å®¶ï¼Œè¯·åˆ†ææ¶æ„å›¾çš„ï¼š
                    1. ç»„ä»¶è®¾è®¡
                    2. æ•°æ®æµå‘
                    3. æ½œåœ¨çš„æ€§èƒ½ç“¶é¢ˆ
                    4. æ”¹è¿›å»ºè®®
                    """)
                .messages(
                    UserMessage.builder()
                        .addText("è¯·åˆ†æè¿™ä¸ªç³»ç»Ÿæ¶æ„å›¾")
                        .addImageUrl(dataUrl, ImageDetail.HIGH)
                        .name("æ¶æ„å¸ˆ")
                        .build()
                )
                .maxCompletionTokens(3000)
                .temperature(0.3)
                .responseFormat(ResponseFormatType.TEXT)
                .build();
            
            // 3. æ‰§è¡Œè¯·æ±‚
            System.out.println("å¼€å§‹åˆ†æå›¾ç‰‡...");
            ChatCompletionResponse response = client
                .chatCompletion(new io.github.pigmesh.ai.deepseek.core.OpenAiClientContext(), request)
                .execute();
            
            // 4. å¤„ç†ç»“æœ
            if (response.choices() != null && !response.choices().isEmpty()) {
                System.out.println("\n=== å›¾ç‰‡åˆ†æç»“æœ ===");
                System.out.println(response.choices().get(0).message().content());
                
                // æ‰“å°æ¨ç†ä¿¡æ¯ï¼ˆå¦‚æœæ”¯æŒï¼‰
                if (response.choices().get(0).reasoningContent() != null) {
                    System.out.println("\n=== æ¨ç†è¿‡ç¨‹ ===");
                    System.out.println(response.choices().get(0).reasoningContent());
                }
            }
            
            client.shutdown();
            
        } catch (Exception e) {
            e.printStackTrace();
        }
    }
}
```

## ğŸ”§ å·¥å…·è°ƒç”¨å®Œæ•´ç¤ºä¾‹

### 5. **Function Calling å·¥ä½œæµ**

```java
import io.github.pigmesh.ai.deepseek.core.DeepSeekClient;
import io.github.pigmesh.ai.deepseek.core.chat.*;
import io.github.pigmesh.ai.deepseek.core.tool.*;
import java.util.List;
import java.util.Map;

public class ToolCallingExample {
    
    public static void main(String[] args) {
        DeepSeekClient client = DeepSeekClient.builder()
            .openAiApiKey("sk-your-key")
            .build();
        
        // 1. å®šä¹‰å·¥å…·å‡½æ•°
        Function weatherFunction = Function.builder()
            .name("get_weather")
            .description("è·å–æŒ‡å®šåŸå¸‚çš„å¤©æ°”ä¿¡æ¯")
            .addParameter("city", Parameter.builder()
                .type("string")
                .description("åŸå¸‚åç§°ï¼Œå¦‚ï¼šåŒ—äº¬ã€ä¸Šæµ·")
                .required(true)
                .build())
            .addParameter("unit", Parameter.builder()
                .type("string")
                .description("æ¸©åº¦å•ä½ï¼šcelsius æˆ– fahrenheit")
                .enumValues(List.of("celsius", "fahrenheit"))
                .defaultValue("celsius")
                .build())
            .build();
        
        Tool weatherTool = Tool.builder()
            .function(weatherFunction)
            .build();
        
        // 2. æ„å»ºå·¥å…·è°ƒç”¨è¯·æ±‚
        ChatCompletionRequest request = ChatCompletionRequest.builder()
            .model("deepseek-chat")
            .addUserMessage("åŒ—äº¬ä»Šå¤©çš„å¤©æ°”æ€ä¹ˆæ ·ï¼Ÿ")
            .tools(weatherTool)
            .toolChoice(ToolChoiceMode.AUTO)
            .parallelToolCalls(true)
            .maxCompletionTokens(2000)
            .temperature(0.2)
            .build();
        
        // 3. æ‰§è¡Œè¯·æ±‚
        System.out.println("å‘é€å·¥å…·è°ƒç”¨è¯·æ±‚...");
        ChatCompletionResponse response = client
            .chatCompletion(new io.github.pigmesh.ai.deepseek.core.OpenAiClientContext(), request)
            .execute();
        
        // 4. å¤„ç†å·¥å…·è°ƒç”¨å“åº”
        if (response.choices() != null && !response.choices().isEmpty()) {
            ChatCompletionChoice choice = response.choices().get(0);
            
            if (choice.message().toolCalls() != null && !choice.message().toolCalls().isEmpty()) {
                System.out.println("æ£€æµ‹åˆ°å·¥å…·è°ƒç”¨è¯·æ±‚:");
                
                for (ToolCall toolCall : choice.message().toolCalls()) {
                    System.out.println("\nå·¥å…·è°ƒç”¨ID: " + toolCall.id());
                    System.out.println("å‡½æ•°åç§°: " + toolCall.function().name());
                    System.out.println("å‡½æ•°å‚æ•°: " + toolCall.function().arguments());
                    
                    // 5. å®é™…æ‰§è¡Œå·¥å…·å‡½æ•°ï¼ˆæ¨¡æ‹Ÿï¼‰
                    String functionName = toolCall.function().name();
                    Map<String, Object> args = parseArguments(toolCall.function().arguments());
                    
                    if ("get_weather".equals(functionName)) {
                        String city = (String) args.get("city");
                        String unit = (String) args.getOrDefault("unit", "celsius");
                        String weatherResult = getWeather(city, unit);
                        
                        System.out.println("æ‰§è¡Œç»“æœ: " + weatherResult);
                        
                        // 6. å°†ç»“æœå‘é€å›AIç»§ç»­å¯¹è¯
                        ChatCompletionRequest followUp = ChatCompletionRequest.builder()
                            .model("deepseek-chat")
                            .messages(
                                SystemMessage.from("ä½ æ˜¯ä¸€ä¸ªå¤©æ°”åŠ©æ‰‹"),
                                UserMessage.from("åŒ—äº¬ä»Šå¤©çš„å¤©æ°”æ€ä¹ˆæ ·ï¼Ÿ"),
                                choice.message(),  // AIçš„åˆå§‹å“åº”ï¼ˆåŒ…å«å·¥å…·è°ƒç”¨ï¼‰
                                ToolMessage.from(toolCall.id(), weatherResult)  // å·¥å…·æ‰§è¡Œç»“æœ
                            )
                            .build();
                        
                        ChatCompletionResponse finalResponse = client
                            .chatCompletion(new io.github.pigmesh.ai.deepseek.core.OpenAiClientContext(), followUp)
                            .execute();
                        
                        if (finalResponse.choices() != null) {
                            System.out.println("\n=== æœ€ç»ˆå›ç­” ===");
                            System.out.println(finalResponse.choices().get(0).message().content());
                        }
                    }
                }
            } else {
                System.out.println("ç›´æ¥å›ç­”: " + choice.message().content());
            }
        }
        
        client.shutdown();
    }
    
    private static Map<String, Object> parseArguments(String jsonArgs) {
        // å®é™…é¡¹ç›®ä¸­åº”ä½¿ç”¨JSONè§£æåº“
        // è¿™é‡Œç®€åŒ–ä¸ºè¿”å›æ¨¡æ‹Ÿæ•°æ®
        return Map.of("city", "åŒ—äº¬", "unit", "celsius");
    }
    
    private static String getWeather(String city, String unit) {
        // æ¨¡æ‹Ÿå¤©æ°”æŸ¥è¯¢
        return String.format("""
            {
                "city": "%s",
                "temperature": 22,
                "unit": "%s",
                "condition": "æ™´æœ—",
                "humidity": "45%%",
                "wind_speed": "10 km/h"
            }
            """, city, unit);
    }
}
```

## ğŸ” æœç´¢å¢å¼ºå¯¹è¯

### 6. **è”ç½‘æœç´¢åŠŸèƒ½**

```java
import io.github.pigmesh.ai.deepseek.core.DeepSeekClient;
import io.github.pigmesh.ai.deepseek.core.search.SearchRequest;
import reactor.core.publisher.Flux;

public class SearchEnhancedChat {
    
    public static void main(String[] args) throws InterruptedException {
        // éœ€è¦é…ç½®æœç´¢APIå¯†é’¥
        DeepSeekClient client = DeepSeekClient.builder()
            .openAiApiKey("sk-your-deepseek-key")
            .searchApiKey("your-search-api-key")  // æœç´¢åŠŸèƒ½çš„APIå¯†é’¥
            .searchEndpoint("https://api.bochaai.com/v1/")
            .build();
        
        String userMessage = "DeepSeekå…¬å¸æœ€æ–°å‘å¸ƒäº†ä»€ä¹ˆäº§å“ï¼Ÿ";
        
        System.out.println("ç”¨æˆ·é—®é¢˜: " + userMessage);
        System.out.println("å¼€å§‹æœç´¢å¢å¼ºå¯¹è¯...\n");
        
        // æ–¹æ³•1: ä½¿ç”¨Fluxæµå¼å“åº”
        Flux<io.github.pigmesh.ai.deepseek.core.chat.ChatCompletionResponse> flux = 
            client.chatSearchCompletion(userMessage);
        
        flux.subscribe(
            chunk -> {
                if (chunk.choices() != null && !chunk.choices().isEmpty()) {
                    String content = chunk.choices().get(0).delta().content();
                    if (content != null) {
                        System.out.print(content);
                    }
                }
            },
            error -> System.err.println("é”™è¯¯: " + error.getMessage()),
            () -> System.out.println("\n\nå¯¹è¯å®Œæˆ")
        );
        
        // æ–¹æ³•2: è‡ªå®šä¹‰æœç´¢è¯·æ±‚
        SearchRequest searchRequest = SearchRequest.builder()
            .enable(true)
            .query(userMessage)
            .searchDepth("advanced")  // æœç´¢æ·±åº¦
            .location("ä¸­å›½")          // åœ°ç†ä½ç½®
            .timePeriod("week")       // æ—¶é—´èŒƒå›´
            .build();
        
        Flux<io.github.pigmesh.ai.deepseek.core.chat.ChatCompletionResponse> customSearch = 
            client.chatSearchCompletion(userMessage, searchRequest);
        
        // ç­‰å¾…å“åº”
        Thread.sleep(5000);
        client.shutdown();
    }
}
```

## ğŸ—ï¸ ç”Ÿäº§çº§å°è£…ç¤ºä¾‹

### 7. **æœåŠ¡ç±»å°è£…**

```java
import io.github.pigmesh.ai.deepseek.core.DeepSeekClient;
import io.github.pigmesh.ai.deepseek.core.chat.*;
import io.github.pigmesh.ai.deepseek.core.OpenAiClientContext;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.util.List;
import java.util.Map;
import java.util.concurrent.CompletableFuture;
import java.util.function.Consumer;

/**
 * DeepSeekæœåŠ¡å°è£…ç±»
 */
public class DeepSeekService {
    
    private static final Logger log = LoggerFactory.getLogger(DeepSeekService.class);
    
    private final DeepSeekClient client;
    private final String defaultModel;
    
    public DeepSeekService(String apiKey, String baseUrl) {
        this.client = DeepSeekClient.builder()
            .openAiApiKey(apiKey)
            .baseUrl(baseUrl)
            .model("deepseek-chat")
            .connectTimeout(java.time.Duration.ofSeconds(30))
            .readTimeout(java.time.Duration.ofSeconds(60))
            .logRequests(log.isDebugEnabled())
            .logResponses(log.isDebugEnabled())
            .build();
        this.defaultModel = "deepseek-chat";
    }
    
    /**
     * åŒæ­¥å¯¹è¯
     */
    public ChatResult chatSync(String systemPrompt, String userMessage) {
        try {
            ChatCompletionRequest request = ChatCompletionRequest.builder()
                .model(defaultModel)
                .addSystemMessage(systemPrompt)
                .addUserMessage(userMessage)
                .maxCompletionTokens(2000)
                .temperature(0.7)
                .build();
            
            ChatCompletionResponse response = client
                .chatCompletion(new OpenAiClientContext(), request)
                .execute();
            
            return extractResult(response);
            
        } catch (Exception e) {
            log.error("åŒæ­¥å¯¹è¯å¤±è´¥", e);
            return ChatResult.error(e.getMessage());
        }
    }
    
    /**
     * æµå¼å¯¹è¯
     */
    public void chatStream(String systemPrompt, String userMessage, 
                          Consumer<String> onChunk, 
                          Runnable onComplete, 
                          Consumer<Exception> onError) {
        
        ChatCompletionRequest request = ChatCompletionRequest.builder()
            .model(defaultModel)
            .addSystemPrompt(systemPrompt)
            .addUserMessage(userMessage)
            .stream(true)
            .maxCompletionTokens(2000)
            .temperature(0.7)
            .build();
        
        client.chatCompletion(new OpenAiClientContext(), request)
            .onPartialResponse(chunk -> {
                if (chunk.choices() != null && !chunk.choices().isEmpty()) {
                    String content = chunk.choices().get(0).delta().content();
                    if (content != null) {
                        onChunk.accept(content);
                    }
                }
            })
            .onComplete(onComplete)
            .onError(onError)
            .execute();
    }
    
    /**
     * å¼‚æ­¥å¯¹è¯
     */
    public CompletableFuture<ChatResult> chatAsync(String systemPrompt, String userMessage) {
        CompletableFuture<ChatResult> future = new CompletableFuture<>();
        
        ChatCompletionRequest request = ChatCompletionRequest.builder()
            .model(defaultModel)
            .addSystemMessage(systemPrompt)
            .addUserMessage(userMessage)
            .maxCompletionTokens(2000)
            .build();
        
        client.chatCompletion(new OpenAiClientContext(), request)
            .onResponse(response -> {
                future.complete(extractResult(response));
                return response;
            })
            .onError(error -> {
                future.completeExceptionally(error);
                return null;
            })
            .executeAsync();
        
        return future;
    }
    
    /**
     * ä»£ç å®¡æŸ¥
     */
    public ChatResult codeReview(String code, String language, String userId) {
        String systemPrompt = String.format("""
            ä½ æ˜¯%sä»£ç å®¡æŸ¥ä¸“å®¶ï¼Œè¯·æŒ‰ä»¥ä¸‹é¡ºåºåˆ†æï¼š
            1. å®‰å…¨é—®é¢˜ï¼ˆSQLæ³¨å…¥ã€XSSç­‰ï¼‰
            2. æ€§èƒ½é—®é¢˜ï¼ˆå¤æ‚åº¦ã€å†…å­˜æ³„æ¼ç­‰ï¼‰
            3. ä»£ç è§„èŒƒï¼ˆå‘½åã€æ³¨é‡Šã€æ ¼å¼ç­‰ï¼‰
            4. æ”¹è¿›å»ºè®®ï¼ˆå…·ä½“ä»£ç ç¤ºä¾‹ï¼‰
            
            ç”¨æˆ·ID: %s
            """, language, userId);
        
        String userMessage = String.format("""
            è¯·å®¡æŸ¥ä»¥ä¸‹%sä»£ç ï¼š
            
            ```%s
            %s
            ```
            """, language, language, code);
        
        ChatCompletionRequest request = ChatCompletionRequest.builder()
            .model("deepseek-chat")
            .addSystemMessage(systemPrompt)
            .addUserMessage(userMessage)
            .maxCompletionTokens(3000)
            .temperature(0.3)
            .metadata(Map.of("type", "code_review", "language", language, "user", userId))
            .build();
        
        try {
            ChatCompletionResponse response = client
                .chatCompletion(new OpenAiClientContext(), request)
                .execute();
            
            return extractResult(response);
            
        } catch (Exception e) {
            log.error("ä»£ç å®¡æŸ¥å¤±è´¥", e);
            return ChatResult.error(e.getMessage());
        }
    }
    
    /**
     * æ–‡ä»¶å†…å®¹åˆ†æ
     */
    public ChatResult analyzeFile(String fileName, String fileContent, String analysisType) {
        String systemPrompt = String.format("""
            ä½ æ˜¯æ–‡æ¡£åˆ†æä¸“å®¶ï¼Œè¿›è¡Œ%såˆ†æã€‚
            è¦æ±‚ï¼šç»“æ„åŒ–è¾“å‡ºã€å…³é”®ç‚¹æå–ã€å…·ä½“å»ºè®®ã€‚
            """, analysisType);
        
        String userMessage = String.format("""
            æ–‡ä»¶åï¼š%s
            åˆ†æç±»å‹ï¼š%s
            
            æ–‡ä»¶å†…å®¹ï¼š
            %s
            """, fileName, analysisType, 
            fileContent.length() > 10000 ? 
                fileContent.substring(0, 10000) + "\n\n[å†…å®¹å·²æˆªæ–­]" : 
                fileContent);
        
        return chatSync(systemPrompt, userMessage);
    }
    
    /**
     * è·å–å¯ç”¨æ¨¡å‹åˆ—è¡¨
     */
    public List<String> getAvailableModels() {
        try {
            return client.models().data().stream()
                .map(model -> model.id())
                .toList();
        } catch (Exception e) {
            log.error("è·å–æ¨¡å‹åˆ—è¡¨å¤±è´¥", e);
            return List.of("deepseek-chat", "deepseek-reasoner"); // è¿”å›å·²çŸ¥æ¨¡å‹
        }
    }
    
    /**
     * å…³é—­å®¢æˆ·ç«¯
     */
    public void shutdown() {
        if (client != null) {
            client.shutdown();
        }
    }
    
    // è¾…åŠ©æ–¹æ³•
    private ChatResult extractResult(ChatCompletionResponse response) {
        if (response == null || response.choices() == null || response.choices().isEmpty()) {
            return ChatResult.error("Empty response");
        }
        
        String content = response.choices().get(0).message().content();
        Usage usage = response.usage();
        
        return ChatResult.success(
            content,
            usage.promptTokens(),
            usage.completionTokens(),
            usage.totalTokens()
        );
    }
    
    // ç»“æœå°è£…ç±»
    public static class ChatResult {
        private final boolean success;
        private final String content;
        private final String error;
        private final int promptTokens;
        private final int completionTokens;
        private final int totalTokens;
        
        private ChatResult(boolean success, String content, String error, 
                          int promptTokens, int completionTokens, int totalTokens) {
            this.success = success;
            this.content = content;
            this.error = error;
            this.promptTokens = promptTokens;
            this.completionTokens = completionTokens;
            this.totalTokens = totalTokens;
        }
        
        public static ChatResult success(String content, int promptTokens, 
                                        int completionTokens, int totalTokens) {
            return new ChatResult(true, content, null, promptTokens, completionTokens, totalTokens);
        }
        
        public static ChatResult error(String error) {
            return new ChatResult(false, null, error, 0, 0, 0);
        }
        
        // getters...
        public boolean isSuccess() { return success; }
        public String getContent() { return content; }
        public String getError() { return error; }
        public int getPromptTokens() { return promptTokens; }
        public int getCompletionTokens() { return completionTokens; }
        public int getTotalTokens() { return totalTokens; }
    }
}

// ä½¿ç”¨ç¤ºä¾‹
class ServiceExample {
    public static void main(String[] args) {
        DeepSeekService service = new DeepSeekService(
            System.getenv("DEEPSEEK_API_KEY"),
            "https://api.deepseek.com"
        );
        
        try {
            // 1. åŒæ­¥è°ƒç”¨
            DeepSeekService.ChatResult result = service.chatSync(
                "ä½ æ˜¯ä¸€ä¸ªæŠ€æœ¯æ–‡æ¡£ç¼–å†™åŠ©æ‰‹",
                "è¯·å¸®æˆ‘å†™ä¸€ä¸ªRedisç¼“å­˜çš„Javaä½¿ç”¨æŒ‡å—"
            );
            
            if (result.isSuccess()) {
                System.out.println("å›ç­”: " + result.getContent());
                System.out.println("Tokenä½¿ç”¨: " + result.getTotalTokens());
            }
            
            // 2. ä»£ç å®¡æŸ¥
            String javaCode = """
                public class UserService {
                    public User getUser(String id) {
                        String sql = "SELECT * FROM users WHERE id = '" + id + "'";
                        return jdbcTemplate.queryForObject(sql, User.class);
                    }
                }
                """;
            
            DeepSeekService.ChatResult review = service.codeReview(javaCode, "Java", "dev_001");
            System.out.println("ä»£ç å®¡æŸ¥ç»“æœ: " + review.getContent());
            
            // 3. è·å–å¯ç”¨æ¨¡å‹
            System.out.println("å¯ç”¨æ¨¡å‹: " + service.getAvailableModels());
            
        } finally {
            service.shutdown();
        }
    }
}
```

## ğŸ¯ å®Œæ•´å·¥ä½œæµç¤ºä¾‹

### 8. **ä»åˆå§‹åŒ–åˆ°å“åº”çš„å®Œæ•´æµç¨‹**

```java
import io.github.pigmesh.ai.deepseek.core.DeepSeekClient;
import io.github.pigmesh.ai.deepseek.core.chat.*;
import io.github.pigmesh.ai.deepseek.core.OpenAiClientContext;

import java.util.ArrayList;
import java.util.List;
import java.util.Scanner;

/**
 * å®Œæ•´çš„å¯¹è¯å¼åº”ç”¨ç¤ºä¾‹
 */
public class CompleteWorkflowExample {
    
    private DeepSeekClient client;
    private List<Message> conversationHistory;
    
    public CompleteWorkflowExample(String apiKey) {
        // 1. åˆå§‹åŒ–å®¢æˆ·ç«¯
        this.client = DeepSeekClient.builder()
            .openAiApiKey(apiKey)
            .baseUrl("https://api.deepseek.com")
            .model("deepseek-chat")
            .systemMessage("ä½ æ˜¯ä¸€ä¸ªæœ‰å¸®åŠ©çš„AIåŠ©æ‰‹")
            .connectTimeout(java.time.Duration.ofSeconds(30))
            .logRequests(true)
            .build();
        
        // 2. åˆå§‹åŒ–å¯¹è¯å†å²
        this.conversationHistory = new ArrayList<>();
        this.conversationHistory.add(
            SystemMessage.builder()
                .content("ä½ æ˜¯ä¸€ä¸ªå‹å¥½çš„AIåŠ©æ‰‹ï¼Œå›ç­”è¦ç®€æ´æ˜äº†ã€‚")
                .build()
        );
    }
    
    /**
     * å‘é€æ¶ˆæ¯å¹¶è·å–å“åº”
     */
    public String sendMessage(String userMessage) {
        try {
            // 3. æ·»åŠ ç”¨æˆ·æ¶ˆæ¯åˆ°å†å²
            conversationHistory.add(UserMessage.from(userMessage));
            
            // 4. æ„å»ºè¯·æ±‚
            ChatCompletionRequest request = ChatCompletionRequest.builder()
                .messages(conversationHistory)
                .maxCompletionTokens(2000)
                .temperature(0.7)
                .build();
            
            // 5. æ‰§è¡Œè¯·æ±‚
            System.out.println("æ­£åœ¨ä¸DeepSeeké€šä¿¡...");
            ChatCompletionResponse response = client
                .chatCompletion(new OpenAiClientContext(), request)
                .execute();
            
            // 6. å¤„ç†å“åº”
            if (response.choices() != null && !response.choices().isEmpty()) {
                String aiResponse = response.choices().get(0).message().content();
                
                // 7. æ·»åŠ AIå“åº”åˆ°å†å²
                conversationHistory.add(AssistantMessage.from(aiResponse));
                
                // 8. é™åˆ¶å†å²é•¿åº¦
                if (conversationHistory.size() > 20) {
                    conversationHistory = conversationHistory.subList(
                        conversationHistory.size() - 10, conversationHistory.size()
                    );
                }
                
                // 9. è¿”å›ç»“æœ
                return aiResponse + 
                    "\n\n[Tokens: " + response.usage().totalTokens() + "]";
            }
            
            return "æŠ±æ­‰ï¼Œæ²¡æœ‰æ”¶åˆ°å“åº”";
            
        } catch (Exception e) {
            // ç§»é™¤å¤±è´¥çš„ç”¨æˆ·æ¶ˆæ¯
            conversationHistory.remove(conversationHistory.size() - 1);
            return "é”™è¯¯: " + e.getMessage();
        }
    }
    
    /**
     * æµå¼å¯¹è¯
     */
    public void streamConversation(String userMessage) {
        conversationHistory.add(UserMessage.from(userMessage));
        
        ChatCompletionRequest request = ChatCompletionRequest.builder()
            .messages(conversationHistory)
            .stream(true)
            .maxCompletionTokens(2000)
            .build();
        
        StringBuilder fullResponse = new StringBuilder();
        
        client.chatCompletion(new OpenAiClientContext(), request)
            .onPartialResponse(chunk -> {
                if (chunk.choices() != null && !chunk.choices().isEmpty()) {
                    String content = chunk.choices().get(0).delta().content();
                    if (content != null) {
                        System.out.print(content);
                        fullResponse.append(content);
                    }
                }
            })
            .onComplete(() -> {
                System.out.println("\n\n[æµå¼å“åº”å®Œæˆ]");
                conversationHistory.add(AssistantMessage.from(fullResponse.toString()));
            })
            .onError(error -> {
                System.err.println("æµå¼é”™è¯¯: " + error.getMessage());
                conversationHistory.remove(conversationHistory.size() - 1);
            })
            .execute();
    }
    
    /**
     * æ¸…ç©ºå¯¹è¯å†å²
     */
    public void clearHistory() {
        this.conversationHistory.clear();
        this.conversationHistory.add(
            SystemMessage.builder()
                .content("ä½ æ˜¯ä¸€ä¸ªå‹å¥½çš„AIåŠ©æ‰‹")
                .build()
        );
        System.out.println("å¯¹è¯å†å²å·²æ¸…ç©º");
    }
    
    /**
     * å…³é—­å®¢æˆ·ç«¯
     */
    public void shutdown() {
        if (client != null) {
            client.shutdown();
        }
    }
    
    /**
     * äº¤äº’å¼æ§åˆ¶å°
     */
    public void startInteractiveConsole() {
        Scanner scanner = new Scanner(System.in);
        System.out.println("=== DeepSeek äº¤äº’å¼æ§åˆ¶å° ===");
        System.out.println("å‘½ä»¤: /clear æ¸…ç©ºå†å², /quit é€€å‡º, /stream æµå¼æ¨¡å¼");
        
        while (true) {
            System.out.print("\nä½ : ");
            String input = scanner.nextLine().trim();
            
            if (input.isEmpty()) continue;
            
            if ("/quit".equalsIgnoreCase(input)) {
                break;
            } else if ("/clear".equalsIgnoreCase(input)) {
                clearHistory();
                continue;
            } else if ("/stream".equalsIgnoreCase(input)) {
                System.out.print("æµå¼æ¶ˆæ¯: ");
                String streamMsg = scanner.nextLine();
                System.out.print("AI: ");
                streamConversation(streamMsg);
                continue;
            }
            
            System.out.print("AI: ");
            String response = sendMessage(input);
            System.out.println(response);
        }
        
        scanner.close();
        shutdown();
        System.out.println("å†è§ï¼");
    }
    
    public static void main(String[] args) {
        String apiKey = System.getenv("DEEPSEEK_API_KEY");
        if (apiKey == null || apiKey.trim().isEmpty()) {
            System.err.println("è¯·è®¾ç½® DEEPSEEK_API_KEY ç¯å¢ƒå˜é‡");
            return;
        }
        
        CompleteWorkflowExample app = new CompleteWorkflowExample(apiKey);
        app.startInteractiveConsole();
    }
}
```

## ğŸ“ å…³é”®ç‚¹æ€»ç»“

### **å®¢æˆ·ç«¯ä½¿ç”¨æµç¨‹ï¼š**

1. **åˆå§‹åŒ–**ï¼š`DeepSeekClient.builder().openAiApiKey().build()`
2. **æ„å»ºè¯·æ±‚**ï¼šä½¿ç”¨ `ChatCompletionRequest.builder()` 
3. **æ‰§è¡Œè°ƒç”¨**ï¼š
   - åŒæ­¥ï¼š`.execute()`
   - å¼‚æ­¥ï¼š`.executeAsync()`
   - æµå¼ï¼š`.onPartialResponse()` + `.execute()`
4. **å¤„ç†å“åº”**ï¼šä» `ChatCompletionResponse` æå–å†…å®¹
5. **èµ„æºæ¸…ç†**ï¼š`client.shutdown()`

### **æœ€ä½³å®è·µï¼š**

- ä»ç¯å¢ƒå˜é‡è·å– API å¯†é’¥
- è®¾ç½®åˆç†çš„è¶…æ—¶æ—¶é—´
- å¯ç”¨æ—¥å¿—ä¾¿äºè°ƒè¯•
- ä½¿ç”¨ `finally` å—ç¡®ä¿ `shutdown()` è¢«è°ƒç”¨
- æµå¼å“åº”é€‚åˆé•¿æ–‡æœ¬ç”Ÿæˆ
- å¼‚æ­¥è°ƒç”¨é€‚åˆ UI åº”ç”¨

è¿™ä¸ªå®Œæ•´çš„ç¤ºä¾‹å±•ç¤ºäº†ä»å®¢æˆ·ç«¯åˆå§‹åŒ–åˆ°è¯·æ±‚æ„å»ºã€æ‰§è¡Œå’Œå“åº”å¤„ç†çš„å®Œæ•´æµç¨‹ã€‚ä½ å¯ä»¥æ ¹æ®å…·ä½“éœ€æ±‚é€‰æ‹©åˆé€‚çš„è°ƒç”¨æ–¹å¼ã€‚